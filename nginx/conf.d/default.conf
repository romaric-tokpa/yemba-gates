# =============================================================================
# CONFIGURATION NGINX - RECRUTEMENT APP
# =============================================================================
# Configuration complète pour router toutes les routes frontend/backend
# 
# Stratégie de routage (ordre de priorité):
# 1. Fichiers statiques (/static/, /uploads/)
# 2. Routes API backend spécifiques
# 3. Frontend Next.js (catch-all pour toutes les autres routes)

server {
    listen 80;
    server_name localhost;

    client_max_body_size 50M;

    # =========================================================================
    # FICHIERS STATIQUES (priorité haute pour performance)
    # =========================================================================
    # Fichiers statiques servis par le backend FastAPI
    location /static/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Uploads (CVs, photos, etc.) servis par le backend FastAPI
    location /uploads/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
        expires 7d;
        add_header Cache-Control "public";
    }

    # =========================================================================
    # API BACKEND - Routes spécifiques (priorité avant le catch-all frontend)
    # =========================================================================
    
    # Route racine de l'API
    location = / {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check et documentation (sans logs pour réduire le bruit)
    location ~ ^/(health|docs|openapi\.json)$ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }

    # Routes API /auth/* spécifiques du backend
    # Exclut /auth/choice et /auth/login (routes frontend gérées par Next.js)
    # Note: Les appels POST vers /auth/login depuis le frontend utilisent NEXT_PUBLIC_API_URL
    # qui pointe directement vers le backend (http://localhost:8000) en développement
    location ~ ^/auth/(register|me|users)(/.*)?$ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }

    # Toutes les routes API backend (ordre alphabétique pour clarté)
    # - /admin/* - Administration
    # - /applications/* - Candidatures
    # - /candidates/* - Candidats
    # - /client-interview-requests/* - Demandes d'entretien client
    # - /history/* - Historique
    # - /interviews/* - Entretiens
    # - /jobs/* - Offres d'emploi
    # - /kpi/* - Indicateurs de performance
    # - /notifications/* - Notifications
    # - /offers/* - Offres
    # - /onboarding/* - Intégration
    # - /shortlists/* - Listes de sélection
    # - /teams/* - Équipes
    location ~ ^/(admin|applications|candidates|client-interview-requests|history|interviews|jobs|kpi|notifications|offers|onboarding|shortlists|teams)(/.*)?$ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }

    # =========================================================================
    # FRONTEND - Toutes les autres routes (catch-all)
    # =========================================================================
    # Inclut:
    # - Toutes les pages Next.js (/auth/choice, /auth/login GET, /manager/*, /recruiter/*, /client/*, etc.)
    # - Les routes frontend qui ne sont pas des API
    # - Les assets Next.js (_next/static, etc.)
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_buffering off;
        # Timeout pour les requêtes longues (SSR, etc.)
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
    }
}
